---
title: "eneRgyVD: profil énergétique"
subtitle: "Direction générale de l'environnement - Direction de l'énergie (DGE-DIREN)"
author: "Unité Données Indicateurs"
date: "`r Sys.Date()`"
always_allow_html: yes
output:
  html_document:
    code_folding: hide
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: TRUE
    code_download: TRUE
fontsize: 11pt

#bibliography: references.bib

#paramètres pour l'export Shiny (cons_data removed temporarily)
params:
  communes: NULL
  web_width: NULL
  web_height: NULL
  unit: NULL
  prod_data: NULL
  regener_data_0: NULL
  regener_data_1: NULL
  regener_data_2: NULL
  regener_data_3: NULL
  
---

```{r setup, include=FALSE}
# Basic knitr behavior
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, comment = 'Note:')
library(eneRgyVD)
```

```{css basic-theme, echo = FALSE}
.main-container {
    margin-left: 30px;
}

.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
    z-index: 2;
    color: white;
    background-color: darkgreen;
    border-color: white;
}

h2,h3,h4,h5,h6{
  font-size: 13pt;
  color:midnightblue;
}

h1{
font-size:14pt;
color:midnightblue;
}
```

Ce rapport a été généré depuis l'application [stat-energie-vd.ch](https://stat-energie-vd.ch/).

Le contenu de ce rapport sera adapté progressivement en fonction des données disponibles ainsi que des fonctionnalités souhaitées par les utilisateurs.

# Rapport énergétique

Ce rapport a été généré pour `r knitr::combine_words(words = params$communes,sep = ", ",and = " et ",oxford_comma = F)`.


## Production d'électricité

### Tableau

```{r}

# params$prod_data |> 
#     eneRgyVD::create_prod_table_dt(unit = params$unit)


test_prod <- function(data, unit, DT_dom = "Bfrtip" # we set default with Buttons
                                 ){

  data %>%
    # Basic clean up for table output
    dplyr::mutate(
      # change year to factor %>%
      annee = as.factor(annee),
      # format numeric cols
      across(where(is.numeric), ~format(.x,
                                        big.mark = "'",
                                        digits = 3,
                                        drop0trailing = TRUE,
                                        scientific = FALSE))) %>%
    dplyr::select(-c(numero_de_la_commune)) %>%
    dplyr::relocate(commune, annee, categorie,
                    production, injection, autoconsommation,
                    puissance_electrique_installee) %>%
    # add icons HTML tags from utils_helpers.R
    dplyr::left_join(prod_icons, by = "categorie") %>%
    dplyr::relocate(icon, .before = categorie) %>%
    dplyr::rename(" " = "icon") %>% # empty colname for icons
    rename_fr_colnames() %>%  # fct_helpers.R
    add_colname_units(unit = unit) %>%  # fct_helpers.R
    #turn to DT
    DT::datatable(escape = F, # rendering the icons instead of text
                  extensions = 'Buttons',
                  options = list(paging = TRUE,    # paginate the output
                                 pageLength = 15,  # number of rows to output for each page
                                 scrollY = TRUE,   # enable scrolling on Y axis
                                 autoWidth = TRUE, # use smart column width handling
                                 server = FALSE,   # use server-side processing
                                 dom = DT_dom, # dynamic according to needs
                                 buttons = list(
                                    list(extend = 'copy', text = "Copier"),
                                    list(extend = 'excel', filename = paste0("prod_elec_vd_", Sys.Date()))
                                    ),
                                 columnDefs = list(list(targets = "_all", className = 'dt-center')),
                                 # https://rstudio.github.io/DT/004-i18n.html   for languages
                                  language = DT_fr_language # from utils_helpers.R !
    ),
    selection = 'single', # enable selection of a single row
    rownames = FALSE      # don't show row numbers/names
    ) # End DT
}

params$prod_data |> 
  test_prod(unit = params$unit)


```

### Graphique

```{r}

params$prod_data |>
    eneRgyVD::create_bar_plotly(unit = params$unit,
                                n_communes = length(params$communes),
                                # web_width = params$web_width, # manually defined
                                # web_height = params$web_height, # manually defined
                                var_year = "annee",
                                var_commune = "commune",
                                var_rank_2 = "categorie",
                                var_values = "production",
                                color_palette = eneRgyVD::return_palette_prod_elec(),
                                dodge = F,
                                free_y = F,
                                legend_title = "Technologies")

```

## Chaleur des bâtiments

### Tableaux

Par usage : 

```{r}

params$regener_data_1 |>
  eneRgyVD::create_regener_table_dt(unit = params$unit)

```


Par affectation :

```{r}

params$regener_data_2 |>
  eneRgyVD::create_regener_table_dt(unit = params$unit)

```


### Graphiques

```{r}
# Use # of communes so that some plot chunk's height can be sized accordingly
# # 400 being default px for 1 row, 0.0104 is the approx conversion from px to inch
height_facet_plots = ceiling(length(params$communes)/2)*400*0.01
```



```{r fig.height= height_facet_plots, fig.width = 12}

params$regener_data_1 |>
  eneRgyVD::lump_alluvial_factors(var_commune = "commune",
                                var_flow = "consommation",
                                var_from = "ae",
                                var_to = "usage") |>
  eneRgyVD::create_alluvial_chart(var_commune = "commune",
                                  var_flow = "consommation",
                                  var_from = "ae",
                                  label_from = "Consommation",
                                  var_to = "usage",
                                  label_to = "Usage")

```



# Contact

Pour tout problème, suggestion d'amélioration ou remarque, n'hésitez pas à prendre contact avec le service en charge de ce projet :

DGE-DIREN, [stat.energie@vd.ch](mailto:stat.energie@vd.ch)









